#!/usr/bin/env bash
#
# Git pre-push hook to run quality checks before pushing
# This prevents pushing code that will fail CI/CD
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-push checks...${NC}"

# Get the current branch
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# Check if we're pushing to develop or main
while read local_ref local_sha remote_ref remote_sha; do
    if [[ "$remote_ref" =~ refs/heads/(develop|main) ]]; then
        echo -e "${YELLOW}Detected push to ${remote_ref##*/}, running quality checks...${NC}"
        
        # Detect changed apps/services
        changed_files=$(git diff --name-only origin/${remote_ref##*/}...HEAD 2>/dev/null || git diff --name-only HEAD~1...HEAD)
        
        # Check if landing-page changed
        if echo "$changed_files" | grep -q "^apps/landing-page/"; then
            echo -e "${YELLOW}Landing page changes detected, running checks...${NC}"
            
            cd apps/landing-page
            
            # Check if dependencies are installed
            if [ ! -d "node_modules" ]; then
                echo -e "${YELLOW}Installing dependencies...${NC}"
                pnpm install --frozen-lockfile
            fi
            
            # Run type check
            echo -e "${YELLOW}Running type check...${NC}"
            if ! pnpm run type-check; then
                echo -e "${RED}❌ Type check failed!${NC}"
                exit 1
            fi
            echo -e "${GREEN}✓ Type check passed${NC}"
            
            # Run linter
            echo -e "${YELLOW}Running linter...${NC}"
            if ! pnpm run lint; then
                echo -e "${RED}❌ Linting failed!${NC}"
                echo -e "${YELLOW}Tip: Run 'pnpm run lint:fix' to automatically fix formatting issues${NC}"
                exit 1
            fi
            echo -e "${GREEN}✓ Linting passed${NC}"
            
            # Run unit tests
            echo -e "${YELLOW}Running unit tests...${NC}"
            if ! pnpm run test:unit; then
                echo -e "${RED}❌ Unit tests failed!${NC}"
                exit 1
            fi
            echo -e "${GREEN}✓ Unit tests passed${NC}"
            
            cd ../..
        fi
        
        # Add checks for other apps/services here as they are developed
        # if echo "$changed_files" | grep -q "^services/accounts/"; then
        #     echo "Checking accounts service..."
        # fi
    fi
done

echo -e "${GREEN}✅ All pre-push checks passed!${NC}"
exit 0
