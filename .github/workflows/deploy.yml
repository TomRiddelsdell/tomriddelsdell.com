name: Deploy

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main

env:
  NODE_VERSION: "20"

jobs:
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test
        env:
          CI: true

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: quality-gates
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: |
          doppler run --project tomriddelsdell-infra --config stg --token ${{ secrets.DOPPLER_TOKEN_STAGING }} -- npm run build

      - name: Deploy to Staging
        run: |
          doppler run --project tomriddelsdell-infra --config stg --token ${{ secrets.DOPPLER_TOKEN_STAGING }} -- npm run deploy:staging

      - name: Health Check
        run: |
          doppler run --project tomriddelsdell-infra --config stg --token ${{ secrets.DOPPLER_TOKEN_STAGING }} -- npm run health-check:staging

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.changes.outputs.apps }}
      services: ${{ steps.changes.outputs.services }}
      infra: ${{ steps.changes.outputs.infra }}
      any-changes: ${{ steps.changes.outputs.any-changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }})
          else
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Detect changed apps
          CHANGED_APPS=$(echo "$CHANGED_FILES" | grep '^apps/' | cut -d'/' -f2 | sort -u | tr '\n' ' ')
          CHANGED_SERVICES=$(echo "$CHANGED_FILES" | grep '^services/' | cut -d'/' -f2 | sort -u | tr '\n' ' ')

          # Check for infrastructure changes
          INFRA_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^(infra/|\.github/workflows/|Makefile|deploy/)' | wc -l)

          # Set outputs
          echo "apps=${CHANGED_APPS}" >> $GITHUB_OUTPUT
          echo "services=${CHANGED_SERVICES}" >> $GITHUB_OUTPUT
          echo "infra=${INFRA_CHANGES}" >> $GITHUB_OUTPUT

          if [ -n "$CHANGED_APPS" ] || [ -n "$CHANGED_SERVICES" ] || [ "$INFRA_CHANGES" -gt 0 ]; then
            echo "any-changes=true" >> $GITHUB_OUTPUT
          else
            echo "any-changes=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: [test, security, detect-changes]
    runs-on: ubuntu-latest
    if: |
      needs.detect-changes.outputs.any-changes == 'true' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    strategy:
      matrix:
        environment: [staging, production]
        exclude:
          - environment: production
            ref: ${{ github.ref != 'refs/heads/main' }}
          - environment: staging
            ref: ${{ github.ref != 'refs/heads/develop' }}

    environment:
      name: ${{ matrix.environment }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          # Install required CLI tools
          sudo apt-get update
          sudo apt-get install -y make jq

          # Install Doppler CLI
          curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh | sudo sh

          # Install Wrangler CLI
          npm install -g wrangler@latest

          # Install AWS CLI
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Authenticate with Doppler
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_SERVICE_TOKEN }}
        run: |
          doppler configure set token $DOPPLER_TOKEN
          doppler configure set project copilot-monorepo
          doppler configure set config ${{ matrix.environment }}

      - name: Deploy infrastructure changes
        if: needs.detect-changes.outputs.infra > 0
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_SERVICE_TOKEN }}
        run: |
          echo "üèóÔ∏è Deploying infrastructure changes..."
          ENV=${{ matrix.environment }} make deploy-infra

      - name: Deploy changed applications
        id: deploy
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_SERVICE_TOKEN }}
        run: |
          ENV=${{ matrix.environment }}

          # Deploy changed apps
          if [ -n "${{ needs.detect-changes.outputs.apps }}" ]; then
            for app in ${{ needs.detect-changes.outputs.apps }}; do
              echo "üöÄ Deploying app: $app"
              make deploy-app APP=$app ENV=$ENV
            done
          fi

          # Deploy changed services
          if [ -n "${{ needs.detect-changes.outputs.services }}" ]; then
            for service in ${{ needs.detect-changes.outputs.services }}; do
              echo "üöÄ Deploying service: $service"
              make deploy-service SERVICE=$service ENV=$ENV
            done
          fi

          # Output deployment URL for environment
          echo "url=https://${{ matrix.environment }}.example.com" >> $GITHUB_OUTPUT

      - name: Run health checks
        run: |
          ENV=${{ matrix.environment }}

          # Health check deployed apps
          if [ -n "${{ needs.detect-changes.outputs.apps }}" ]; then
            for app in ${{ needs.detect-changes.outputs.apps }}; do
              echo "üè• Health checking app: $app"
              make health-check-app APP=$app ENV=$ENV
            done
          fi

          # Health check deployed services
          if [ -n "${{ needs.detect-changes.outputs.services }}" ]; then
            for service in ${{ needs.detect-changes.outputs.services }}; do
              echo "üè• Health checking service: $service"
              make health-check-service SERVICE=$service ENV=$ENV
            done
          fi
