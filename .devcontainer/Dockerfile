# Portfolio Platform Development Container
# Optimized for event-sourced microservices development
FROM mcr.microsoft.com/devcontainers/universal:2-linux

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive

# Update package lists and install essential system tools (cached layer)
RUN apt-get update -y && apt-get install -y \
    curl \
    wget \
    unzip \
    jq \
    git \
    build-essential \
    gnupg \
    lsb-release \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# Install all CLI tools in a single layer to ensure consistency
RUN echo "ðŸ”§ Installing CLI tools for Portfolio Platform..." && \
    # Install Doppler CLI (Secrets Management)
    echo "ðŸ” Installing Doppler CLI..." && \
    curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh | sh && \
    # Install Confluent CLI (Kafka Management) 
    echo "ðŸ“Š Installing Confluent CLI..." && \
    cd /tmp && \
    curl -L --http1.1 https://cnfl.io/cli | sh -s -- latest && \
    mv bin/confluent /usr/local/bin/confluent && \
    # Switch to codespace user for npm installs to use correct Node.js environment
    echo "â˜ï¸ Installing Wrangler and Neon CLI as codespace user..." && \
    su - codespace -c "npm install -g wrangler@latest neonctl@latest" && \
    # Install additional development tools as codespace user
    echo "ðŸ› ï¸ Installing additional development utilities..." && \
    su - codespace -c "npm install -g @playwright/test eslint prettier typescript ts-node nodemon turbo@latest" && \
    # Install Avro tools for event schema management as codespace user
    echo "ðŸ“‹ Installing Avro tools for event sourcing..." && \
    su - codespace -c "npm install -g avro-typescript avro-js @kafkajs/confluent-schema-registry"

# Reset to interactive mode
ENV DEBIAN_FRONTEND=

# Verification layer (will show in build output and help debug issues)
RUN echo "âœ… Installation verification:" && \
    echo "  â€¢ Node.js: $(node --version)" && \
    echo "  â€¢ npm: $(npm --version)" && \
    echo "  â€¢ pnpm: $(pnpm --version)" && \
    echo "  â€¢ Doppler: $(doppler --version 2>/dev/null || echo 'MISSING')" && \
    echo "  â€¢ Confluent CLI: $(confluent version 2>/dev/null | head -n1 || echo 'MISSING')" && \
    echo "  â€¢ Terraform: $(terraform --version 2>/dev/null | head -n1 || echo 'from features')" && \
    echo "  â€¢ AWS CLI: $(aws --version 2>/dev/null | head -n1 || echo 'from features')" && \
    echo "  â€¢ GitHub CLI: $(gh --version 2>/dev/null | head -n1 || echo 'from base image')" && \
    echo "  â€¢ Git: $(git --version)" && \
    # Test as codespace user for npm-installed tools
    echo "ðŸ” Testing tools as codespace user..." && \
    su - codespace -c "wrangler --version" && echo "  âœ… Wrangler OK" && \
    su - codespace -c "neonctl --version" && echo "  âœ… Neon CLI OK" && \
    # Fail the build if critical tools are missing
    echo "ðŸ” Verifying critical CLI tools are accessible..." && \
    doppler --version > /dev/null && echo "  âœ… Doppler OK" && \
    confluent version > /dev/null && echo "  âœ… Confluent CLI OK"

# Switch back to codespace user
USER codespace