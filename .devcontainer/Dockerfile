# Portfolio Platform Development Container
# Optimized for event-sourced microservices development
# Using Universal Dev Container 4.x with Ubuntu 24.04 (Noble) for modern glibc 2.39 and comprehensive tooling
FROM mcr.microsoft.com/devcontainers/universal:4-linux

# Set environment variables for build
ENV DEBIAN_FRONTEND=noninteractive

# Configure npm global directory following Node.js Docker best practices
# This avoids permission issues by using a shared location accessible to both root and codespace users
ENV NPM_CONFIG_PREFIX=/usr/local/share/npm-global
ENV PATH=/usr/local/share/npm-global/bin:$PATH

# Update package lists and install essential system tools (cached layer)
RUN apt-get update -y && apt-get install -y \
    curl \
    wget \
    unzip \
    jq \
    git \
    build-essential \
    gnupg \
    lsb-release \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# Set up npm global directory with proper permissions
RUN mkdir -p /usr/local/share/npm-global \
    && chown codespace:nvm /usr/local/share/npm-global \
    && chmod 755 /usr/local/share/npm-global

# Install CLI tools following official best practices
RUN echo "ðŸ”§ Installing CLI tools for Portfolio Platform..." && \
    # Install Doppler CLI (Secrets Management)
    echo "ðŸ” Installing Doppler CLI..." && \
    curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh | sh && \
    # Install Confluent CLI (Kafka Management)
    echo "ðŸ“Š Installing Confluent CLI..." && \
    cd /tmp && \
    curl -L --http1.1 https://cnfl.io/cli | sh -s -- latest && \
    mv bin/confluent /usr/local/bin/confluent && \
    # Install npm-based CLI tools using configured global prefix (runs as root but installs to shared location)
    echo "â˜ï¸ Installing npm-based CLI tools globally..." && \
    npm install -g pnpm@latest wrangler@latest neonctl@latest && \
    # Install Claude CLI (AI-Powered Coding Assistant via npm)
    echo "ðŸ¤– Installing Claude CLI..." && \
    npm install -g @anthropic-ai/claude-code && \
    # Install additional development tools
    echo "ðŸ› ï¸ Installing additional development utilities..." && \
    npm install -g @playwright/test eslint prettier typescript ts-node nodemon turbo@latest && \
    # Install Avro tools for event schema management
    echo "ðŸ“‹ Installing Avro tools for event sourcing..." && \
    npm install -g avro-typescript avro-js @kafkajs/confluent-schema-registry

# Reset to interactive mode
ENV DEBIAN_FRONTEND=

# Verification layer (will show in build output and help debug issues)
RUN echo "âœ… Installation verification:" && \
    echo "  â€¢ Node.js: $(node --version)" && \
    echo "  â€¢ npm: $(npm --version)" && \
    echo "  â€¢ pnpm: $(pnpm --version)" && \
    echo "  â€¢ Doppler: $(doppler --version 2>/dev/null || echo 'MISSING')" && \
    echo "  â€¢ Claude CLI: $(claude --version 2>/dev/null || echo 'MISSING')" && \
    echo "  â€¢ Confluent CLI: $(confluent version 2>/dev/null | head -n1 || echo 'MISSING')" && \
    echo "  â€¢ Terraform: $(terraform --version 2>/dev/null | head -n1 || echo 'from features')" && \
    echo "  â€¢ AWS CLI: $(aws --version 2>/dev/null | head -n1 || echo 'from features')" && \
    echo "  â€¢ GitHub CLI: $(gh --version 2>/dev/null | head -n1 || echo 'from base image')" && \
    echo "  â€¢ Git: $(git --version)" && \
    # Check npm packages using global prefix
    echo "  â€¢ Wrangler: $(wrangler --version 2>/dev/null || echo 'MISSING')" && \
    echo "  â€¢ Neon CLI: $(neonctl --version 2>/dev/null || echo 'MISSING')" && \
    echo "  â€¢ ESLint: $(eslint --version 2>/dev/null || echo 'MISSING')" && \
    echo "  â€¢ TypeScript: $(tsc --version 2>/dev/null || echo 'MISSING')" && \
    # Fail the build if critical tools are missing
    echo "ðŸ” Verifying critical CLI tools are accessible..." && \
    doppler --version > /dev/null && echo "  âœ… Doppler OK" && \
    claude --version > /dev/null && echo "  âœ… Claude CLI OK" && \
    wrangler --version > /dev/null && echo "  âœ… Wrangler OK" && \
    neonctl --version > /dev/null && echo "  âœ… Neon CLI OK" && \
    confluent version > /dev/null && echo "  âœ… Confluent CLI OK" && \
    eslint --version > /dev/null && echo "  âœ… ESLint OK" && \
    tsc --version > /dev/null && echo "  âœ… TypeScript OK"

# Switch back to codespace user for runtime
USER codespace