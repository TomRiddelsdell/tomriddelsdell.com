{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Small Neptune cluster for testing - Created for tomriddelsdell.com MCP integration",
  "Parameters": {
    "ClusterIdentifier": {
      "Type": "String",
      "Default": "tomriddelsdell-neptune-test",
      "Description": "Identifier for the Neptune cluster"
    },
    "InstanceClass": {
      "Type": "String",
      "Default": "db.t3.medium",
      "Description": "Instance class for Neptune instances",
      "AllowedValues": ["db.t3.medium", "db.t4g.medium", "db.r5.large"]
    },
    "Environment": {
      "Type": "String",
      "Default": "test",
      "Description": "Environment tag for resources"
    }
  },
  "Resources": {
    "NeptuneSubnetGroup": {
      "Type": "AWS::Neptune::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription": "Subnet group for Neptune cluster",
        "SubnetIds": [
          {"Ref": "PrivateSubnet1"},
          {"Ref": "PrivateSubnet2"}
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Project",
            "Value": "tomriddelsdell.com"
          }
        ]
      }
    },
    "NeptuneClusterParameterGroup": {
      "Type": "AWS::Neptune::DBClusterParameterGroup",
      "Properties": {
        "Family": "neptune1.3",
        "Description": "Parameter group for Neptune cluster",
        "Parameters": {
          "neptune_enable_audit_log": "1",
          "neptune_query_timeout": "120000"
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          }
        ]
      }
    },
    "NeptuneParameterGroup": {
      "Type": "AWS::Neptune::DBParameterGroup",
      "Properties": {
        "Family": "neptune1.3",
        "Description": "Parameter group for Neptune instances",
        "Parameters": {
          "neptune_query_timeout": "120000"
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          }
        ]
      }
    },
    "NeptuneSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for Neptune cluster",
        "VpcId": {"Ref": "VPC"},
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 8182,
            "ToPort": 8182,
            "SourceSecurityGroupId": {"Ref": "ApplicationSecurityGroup"}
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "neptune-security-group"
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          }
        ]
      }
    },
    "NeptuneCluster": {
      "Type": "AWS::Neptune::DBCluster",
      "Properties": {
        "DBClusterIdentifier": {"Ref": "ClusterIdentifier"},
        "Engine": "neptune",
        "EngineVersion": "1.3.2.1",
        "DBSubnetGroupName": {"Ref": "NeptuneSubnetGroup"},
        "DBClusterParameterGroupName": {"Ref": "NeptuneClusterParameterGroup"},
        "VpcSecurityGroupIds": [
          {"Ref": "NeptuneSecurityGroup"}
        ],
        "StorageEncrypted": true,
        "BackupRetentionPeriod": 7,
        "PreferredBackupWindow": "03:00-04:00",
        "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
        "IamAuthEnabled": true,
        "DeletionProtection": false,
        "Tags": [
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Project",
            "Value": "tomriddelsdell.com"
          }
        ]
      }
    },
    "NeptuneInstance1": {
      "Type": "AWS::Neptune::DBInstance",
      "Properties": {
        "DBInstanceIdentifier": {"Fn::Sub": "${ClusterIdentifier}-instance-1"},
        "DBInstanceClass": {"Ref": "InstanceClass"},
        "Engine": "neptune",
        "DBClusterIdentifier": {"Ref": "NeptuneCluster"},
        "DBParameterGroupName": {"Ref": "NeptuneParameterGroup"},
        "Tags": [
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Project",
            "Value": "tomriddelsdell.com"
          }
        ]
      }
    }
  },
  "Outputs": {
    "NeptuneClusterEndpoint": {
      "Description": "Neptune cluster endpoint",
      "Value": {"Fn::GetAtt": ["NeptuneCluster", "Endpoint"]},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-cluster-endpoint"}
      }
    },
    "NeptuneClusterReadEndpoint": {
      "Description": "Neptune cluster read endpoint",
      "Value": {"Fn::GetAtt": ["NeptuneCluster", "ReadEndpoint"]},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-read-endpoint"}
      }
    },
    "NeptuneClusterPort": {
      "Description": "Neptune cluster port",
      "Value": {"Fn::GetAtt": ["NeptuneCluster", "Port"]},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-port"}
      }
    },
    "NeptuneClusterIdentifier": {
      "Description": "Neptune cluster identifier",
      "Value": {"Ref": "NeptuneCluster"},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-cluster-id"}
      }
    }
  }
}
