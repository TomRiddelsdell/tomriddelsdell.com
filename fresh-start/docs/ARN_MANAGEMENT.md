# ARN Management Strategy

## Overview
This document explains how ARNs are managed in our deploym### Migration Complete
As of August 19, 2025, all hardcoded ARNs have been removed from:
- ✅ `deploy-production.sh` - Now uses centralized config
- ✅ `production-stack.yml` - Removed hardcoded certificate ARN default
- ✅ All scripts now follow centralized configuration patternystem to prevent staleness and maintain configuration consistency.

## ARN Categories

### 1. Static ARNs (Never become stale)
These ARNs are persistent across deployments and are managed through our centralized configuration system:

- **SSL Certificates**: ACM certificate ARNs remain constant
  - Managed in: `.env` → `PRODUCTION_CERTIFICATE_ARN`
  - Used by: CloudFormation parameter `CertificateArn`
  - Example: `arn:aws:acm:us-east-1:123456789012:certificate/8755d817-0f2a-4cae-93a3-7afea7d5ccee`

- **AWS Managed Policies**: Built-in IAM policies
  - Examples: `arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole`
  - These are hardcoded in CloudFormation templates (safe - AWS guarantees they never change)

### 2. Dynamic ARNs (Generated each deployment)
These ARNs are generated by CloudFormation and referenced using intrinsic functions:

- **Lambda Function ARNs**: `!GetAtt LambdaFunction.Arn`
- **S3 Bucket ARNs**: `!GetAtt StaticAssetsBucket.Arn`
- **API Gateway ARNs**: `!Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*'`
- **CloudWatch Log Group ARNs**: `!Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*'`

## Configuration System

### Centralized Configuration Flow
1. **Environment Variables** (`.env`)
   ```bash
   PRODUCTION_CERTIFICATE_ARN=arn:aws:acm:us-east-1:123456789012:certificate/8755d817-0f2a-4cae-93a3-7afea7d5ccee
   ```

2. **Config Files** (`config/default.cjs`)
   ```javascript
   integration: {
     github: {
       deployment: {
         productionCertArn: process.env.PRODUCTION_CERTIFICATE_ARN || ''
       }
     }
   }
   ```

3. **Config Loader** (`load-config.cjs`)
   ```javascript
   certificateArn: config.get('integration.github.deployment.productionCertArn')
   ```

4. **Deployment Script** (`deploy-production.sh`)
   ```bash
   CONFIG_OUTPUT=$(node infrastructure/deployment/aws/scripts/load-config.cjs)
   CERTIFICATE_ARN=$(echo "$CONFIG_OUTPUT" | node -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf8')).certificateArn)")
   ```

5. **CloudFormation Parameters**
   ```bash
   --parameters ParameterKey=CertificateArn,ParameterValue="$CERTIFICATE_ARN"
   ```

## Best Practices

### ✅ DO
- Use centralized configuration for all static ARNs
- Use CloudFormation intrinsic functions for dynamic ARNs
- Remove hardcoded ARNs from scripts and templates
- Document which ARNs are static vs dynamic

### ❌ DON'T
- Hardcode ARNs directly in deployment scripts
- Use default values in CloudFormation for ARNs that should come from config
- Mix hardcoded and configuration-based approaches

## Maintenance

### When ARNs Become Stale
- **SSL Certificates**: Only if certificate is deleted/recreated (rare)
- **Dynamic Resources**: Automatically handled by CloudFormation
- **AWS Managed Policies**: Never become stale

### Updating Static ARNs
1. Update the environment variable in `.env`
2. Verify config loading with: `node infrastructure/deployment/aws/scripts/load-config.cjs`
3. Deploy as normal

### Verification
To check for hardcoded ARNs:
```bash
# Check deployment scripts
grep -r "arn:aws" infrastructure/deployment/aws/scripts/

# Check CloudFormation templates  
grep -r "arn:aws" infrastructure/deployment/aws/cloudformation/
```

## Migration Complete
As of August 19, 2025, all hardcoded ARNs have been removed from:
- ✅ `deploy-production.sh` - Now uses centralized config
- ✅ `production-stack.yml` - Removed hardcoded certificate ARN default
- ✅ All scripts now follow centralized configuration pattern

The only remaining static ARN references are:
- Environment variables in `.env` (proper place for static config)
- AWS managed policy ARNs in CloudFormation (safe to hardcode)
